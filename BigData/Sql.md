
# 数据库


## sql
+ 定义别名的方式
    + select 字段 as 别名;    // 更推荐使用 
    + select 字段 别名
    + select 别名=字段
    
    + as后面别名的写法有的加括号、单引号、双引号、以及没有引号
        + 对于别名中含有空格时，以下写法不报错
            + select student as '姓 名'
            + select student as [姓 名]
            + select student as "姓 名"
        + 对于别名中含有空格时，以下写法报错
            + select student as 姓 名





## Hive

+ over：开窗函数，和聚合函数的不同之处是，对于每个组返回多行，而聚合函数对于每个组只返回一行。
    + over (order by salary)：按照salary排序进行累计，order by是个默认的开窗函数
    + over (partition by salary)：按照salary分区

+ collect：将分组中的某列转为一个数组返回
    + collect_list：不会去重
    + collect_set：会去重


## NoSQL
> Not Only SQL：表示关系和非关系数据库各有优缺点，彼此都无法取代

+ 理论基石：BASE
    + BASE：Basically Available Soft state和Eventual consistency的简写，意思是“碱”，BASE和关系数据库中的事务的四个性质ACID(“酸”)对应
        + Basically Available：基本可用，指一个分布式系统的一部分发生问题变得不可用时其它部分仍然可以正常使用，也就是允许分区失败的情形出现
        + Soft state：软状态，指状态可以有一段时间不同步，具有一定的滞后性；（补充：硬状态，指数据库的状态必须一直保持数据库一致性，就是任意时刻数据必须是正确的）
        + Eventual consistency：最终一致性，一致性的类型包括强一致性和弱一致性，二者的主要区别在于高并发的数据访问操作下，后续操作是否能够获取最新的数据。
            + 根据更新数据后各进程访问到数据的时间和方式的不同，可以区分为
                + 因果一致性：如果进程A通知进程B已更新了一个数据项，那么进程B的后续访问将获得A写入的最新值。
                + “读己之所写”一致性：当进程A自己执行一个更新操作之后，它自己总是可以访问更新过的值，不会看到旧值。
                + 单调读一致性：如果进程已经看到过数据对象的某个值，那么任何后续访问，都不会返回在那个值之前的旧值。
                + 会话一致性：它会把访问存储系统的这些进程，放到会话的上下文进程当中，这个时候只要这些会话存在，系统就可以保证读己之所写一致性。
                + 单调写一致性：系统需要保证来自同一个进程的写操作按顺序执行。
+ 如何实现各种类型的一致性
    + 为了实现它的可靠性，需要对数据进行冗余存储
        + N：数据冗余的份数
        + W：更新数据时需保证写完成的节点数
        + R：读取数据的时候需要读取的节点数
    + W+R>N：强一致性，写节点和读节点重叠，比如对于典型的一主一备同步复制的关系型数据库，当N=2,W=2,R=1，则不管读的主库还是备库的数据，都是一致的。
    + W+R<=N：弱一致性，比如对于一主一备异步复制的关系型数据库，N=2,W=1,R=1，则如果读的是备库，就可能无法读取主库已经更新过的数据。
    + N=W,R=1：强一致性，任何一个写节点失效，都会导致写失败，因此可用性会降低，但是由于数据分布的N个节点是同步写入的，因此可以保证强一致性。
    + 实例：HBase数据库：1、借助底层的HDFS来实现其数据冗余备份；2、HDFS采用**强一致性**保证，在数据未完全同步到N个节点前，写操作不会成功返回，也就是说当W=N，而读操作只需要读到一个值即可(R=1)


+ 特点
    + 灵活的可扩展性
    + 灵活的数据模型
    + 和云计算紧密结合

+ 对比
    + 传统的关系数据库性能缺陷
        + 无法满足海量数据的管理需求
        + 无法满足高并发的需求
        + 无法满足高可扩展性和高可用性的需求
    + MySQL集群方式的缺陷
        + 复杂性：整个集群部署管理配置非常复杂
        + 延迟性：当主库压力较大时，就会带来较大的延迟
        + 扩容问题：整个集群压力过大时，需要增加新机器对这个数据集进行重新分区，非常复杂。
    + NoSQL兴起的原因
        + 关系数据库无法满足web2.0的需求：web2.0通常不要求严格数据库事务、不要求严格读写实时性，不包含复杂的SQL查询
        + 数据模型的局限性
        + web2.0关系数据库许多特性没有发挥
    + NoSQL与关系数据库的比较
        + 数据库原理
            + 关系数据库：具有完备的关系代数理论作为基础
            + NoSQL数据库：缺乏理论基础
        + 数据规模方面
            + 关系数据库：很难实现横向扩展，纵向扩展非常有限
            + NoSQL数据库：非常好的水平可扩展性
        + 数据库模式方面
            + 关系数据库：定义严格的数据库模式，而且要严格遵守事先定义的数据库模式
            + NoSQL数据库：数据模型非常灵活
        + 查询效率方面
            + 关系数据库：适当数量级查询效率高，数据量级增大查询效率下降
            + NoSQL数据库：未构建面向复杂查询的索引查询性能差
        + 事务一致性方面
            + 关系数据库：遵循ACID事务模型可以保证事务强一致性
            + NoSQL数据库：采用base模型，只能保证最终一致性，无法保证事务强一致性
        + 数据完整性方面
            + 关系数据库：保证完整性的完备机制
            + NoSQL数据库：不能实现完整性约束
        + 可用性方面
            + 关系数据库：随着数据规模增大，为了保证严格的一致性可用性方面被削弱
            + NoSQL数据库：具有非常好的可用性，能够在短时间内返回结果
        + 标准化方面
            + 关系数据库：遵循SQL标准
            + NoSQL数据库：未形成通用的行业标准
        + 技术支持方面
            + 关系数据库：很多是商业数据库，技术支持好
            + NoSQL数据库：开源产品，技术支持差
        + 可维护方面
            + 关系数据库：需要管理员维护
            + NoSQL数据库：没有成熟的基础和实践操作规范维护较为复杂
        + **优劣势**
            + **关系数据库**：**优势**，具有非常完备的关系代数理论作为基础、有严格的标准、支持事务一致性、可以借助索引机制实现非常高效的查询；**劣势**，可扩展性非常差、不具备水平可扩展性，无法支持海量数据存储、数据模型定义严格，无法较好满足新型web2.0应用需求
            + **NoSQL**：**优势**，支持超大规模的数据存储、数据模型非常灵活；**劣势**，缺乏底层基础理论做支撑、不支持事务的强一致性

+ 键值数据库：一堆键值对，一般是理想的缓冲解决方案。
    + 例子：Redis
    + 典型应用：涉及频繁读写、拥有简单数据模型的应用缓存，如会话、配置文件等，存储配置和用户数据信息等移动应用
    + 不适用场景：键值数据库根本没有通过值查询的途径；在键值数据库中，不能通过两个或两个以上的键来关联数据；在一些键值数据库中，产生故障时，不可以回滚
    + 优点：扩展性好、灵活性好、大量写操作性能高
    + 缺点：无法存储结构化信息、条件查询效率较低
+ 列族数据库：HBase根据列族进行垂直划分，根据行键进行水平划分。
    + 例子：HBase
    + 典型应用：分布式数据存储与管理；拥有动态字段的应用程序
    + 优点：查找速度快、可扩展性强、容易进行分布式扩展、复杂性低
    + 缺点：功能较少，大都不支持强事务一致性
+ 文档数据库：可看做键值数据库，值是文档而非标量
            
    + 特性：能够将数据的内容和类型进行自我描述
        ```
        # 比如一个XML文档，可以从中知道属性、值
        <configuration>
        <property>
        <name>hbase.rootdir</name>
        <value>hdfs://localhost:9000/hbase</value>
        </property>
        </configuration>
        
        关系数据库必须有schema信息才能理解数据的含义
        学生(学号、姓名、性别、年龄、系、年级)
        (1001、张三、男、20、计算机、2002)
        ```
    + 数据结构：JSON
    + 数据模型：本质上是一个键值数据库，不过值是版本化文档
    + 典型应用：存储、索引并管理面向文档的数据或者类似的半结构化数据
    
    + 优势
        + 相比关系数据库，文档数据库可以完整包含在一个文档里，有较好的并发性。在对数据进行更新时，只需锁定一个文档就可以把相关数据修改。
        + 灵活性高，提供嵌入式文档功能，将经常查询的数据存储在同一个文档中
    + 缺点：缺乏统一的查询语法
    + 不适用情形：不支持文档间的事务
    + 例子：mongo DB
        + mongo DB是一种基于分布式文件存储的开源数据库系统；在高负载的情况下，添加更多的节点可以保证服务器性能；为WEB应用提供可扩展的高性能数据存储解决方案。
        + 将数据存储为一个文档，数据结构由键值对组成MongoDB文档类似于JSON对象(称BSON)，字段值可以包含其他文档、数组及文档数组。
        + 特点
            + 提供面向文档存储，操作简单、容易；
            + 可以设置任何属性的索引实现更快的排序；
            + 具有较好的水平可扩展性；
            + 支持丰富的查询表达式，可查询文档中内嵌的对象及数组；
            + 可替换已完成文档某个指定的数据字段
            + 其中的MapReduce主要是用来对数据进行批量处理和聚合操作。
        + MongoDB的文档**不需要设置相同的字段**，并且**相同的字段不需要相同的数据类型**。
+ 图数据库：以图结构方式存储相关信息
    + 例子：Neo4j
    + 数据模型：图结构
    + 典型应用：专门处理具有高度相互关联关系的数据，比较适合于社交网络、模式识别、依赖分析、推荐系统以及路径寻找等问题
    + 优点：灵活性高，支持复杂的图形算法，可用于构建复杂的关系图谱
    + 缺点：数据模型应用范围非常有限

+ 云数据库
    + 优良特性
        + 动态可扩展、高可用性、低使用代价、免维护、易用性、高性能、安全
    + 和其它数据库的关系
        + 数据模型角度：云数据库并非一种全新的数据库技术，只是以服务的方式提供数据库功能；没有自己的数据模型。
    + 例子：RDS、SimpleDB等

### CAP理论
> **Consistency：一致性**，指任何一个读操作总能读到之前完成的写操作的结果；
> **Availability：可用性**，指快速获取数据，可以在确定的时间内返回操作结果，保证每个请求不管成功或者失败都有响应；
> **Partition tolerance：分区容忍性**，指当出现网络分区的情况时(即系统中的一部分节点无法和其它节点进行通信)，分离的系统也能正常运行。
> 一个分布式系统不可能同时满足一致性、可用性和分区容忍性，最多只能同时满足其中两个。

+ CA：把所有与事务相关内容放在同一台机器上，避免网络分区问题。
    + 例子：MySQL、SQL Server
+ CP：使用网络分区，等数据一致后再去取数据，短时间内无法取到数据，失去可用性。
    + 例子：Neo4j、MongoDB、HBase、Redis
+ AP：可及时获取数据，但数据可能不一致
    + 例子：Cassandro



## NewSQL
> 数据库的发展从一种架构支持多类应用转为多架构支持多类应用；
> 根据不同应用场景使用不同数据库：分析型应用场景(用NewSQL支持)、事务型应用场景(用OldSQL支持 )、互联网应用场景(用NoSQL支持)。
> NewSQL同时具备OldSQL数据库和NoSQL数据库各自的优点

+ 优点
    + 非常好的水平可扩展性
    + 强一致性
    + 事务一致性
    + 支持SQL查询
    + 支持海量的数据存储
+ 例子：Amazon RDS、SQL Azure等
